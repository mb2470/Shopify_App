{% comment %}
  OCE SDK Script Tag â€” Shopify Theme App Extension
  Injects the Onsite Commission Engine tracking SDK into the storefront.
  Auto-detects Videowise, Tolstoy, Firework, YouTube, Vimeo, and HTML5 players.
  Handles session persistence, event deduplication, and cross-domain attribution.
{% endcomment %}

{% if app.metafields.oce.api_key != blank and app.metafields.oce.sdk_enabled == "true" %}
  <!-- Onsite Commission Engine SDK -->
  <script
    src="https://app.onsiteaffiliate.com/sdk/oce.min.js"
    data-api-key="{{ app.metafields.oce.api_key }}"
    defer
  ></script>

  <script>
    // Store exposure IDs in cart attributes for order attribution
    (function() {
      'use strict';

      // Listen for OCE exposure events
      window.addEventListener('oce:exposure', function(event) {
        var exposureId = event.detail && event.detail.exposure_id;
        if (!exposureId) return;

        // Get existing exposure IDs from session
        var stored = [];
        try {
          var raw = sessionStorage.getItem('_oce_exposure_ids');
          if (raw) stored = JSON.parse(raw);
        } catch(e) {}

        // Add new ID if not already tracked
        if (stored.indexOf(exposureId) === -1) {
          stored.push(exposureId);
          // Keep only last 50 exposure IDs
          if (stored.length > 50) stored = stored.slice(-50);
          try {
            sessionStorage.setItem('_oce_exposure_ids', JSON.stringify(stored));
          } catch(e) {}
        }

        // Update cart attributes with exposure IDs
        updateCartAttributes(stored);
      });

      // Sync exposure IDs to Shopify cart attributes
      function updateCartAttributes(exposureIds) {
        fetch('/cart/update.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            attributes: {
              '_oce_exposure_ids': JSON.stringify(exposureIds),
              '_oce_session_id': getSessionId()
            }
          })
        }).catch(function(err) {
          console.warn('[OCE] Failed to update cart attributes:', err);
        });
      }

      // Get or create a persistent session ID
      function getSessionId() {
        var key = '_oce_session_id';
        var sessionId = null;

        try {
          sessionId = localStorage.getItem(key);
        } catch(e) {}

        if (!sessionId) {
          sessionId = 'oce_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          try {
            localStorage.setItem(key, sessionId);
          } catch(e) {}
        }

        return sessionId;
      }

      // On page load, ensure any existing exposures are in cart
      document.addEventListener('DOMContentLoaded', function() {
        try {
          var raw = sessionStorage.getItem('_oce_exposure_ids');
          if (raw) {
            var stored = JSON.parse(raw);
            if (stored.length > 0) updateCartAttributes(stored);
          }
        } catch(e) {}
      });
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "OCE Tracking SDK",
  "target": "head",
  "settings": []
}
{% endschema %}

