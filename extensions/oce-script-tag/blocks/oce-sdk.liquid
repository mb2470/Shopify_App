{% comment %}
  OCE SDK Script Tag — Shopify Theme App Extension
  Injects the Onsite Commission Engine tracking SDK into the storefront.
  API key is synced automatically from the app dashboard via metafields.
{% endcomment %}

{% if app.metafields.oce.api_key != blank %}
  <!-- Onsite Commission Engine SDK -->
  <script
    src="https://app.onsiteaffiliate.com/sdk/oce.min.js"
    data-api-key="{{ app.metafields.oce.api_key }}"
    defer
  ></script>
{% endif %}

<!-- Exposure event listener — always active when embed is enabled -->
<script>
  (function() {
    'use strict';

    window.addEventListener('oce:exposure', function(event) {
      var exposureId = event.detail && event.detail.exposure_id;
      if (!exposureId) return;

      var stored = [];
      try {
        var raw = sessionStorage.getItem('_oce_exposure_ids');
        if (raw) stored = JSON.parse(raw);
      } catch(e) {}

      if (stored.indexOf(exposureId) === -1) {
        stored.push(exposureId);
        if (stored.length > 50) stored = stored.slice(-50);
        try {
          sessionStorage.setItem('_oce_exposure_ids', JSON.stringify(stored));
        } catch(e) {}
      }

      updateCartAttributes(stored);
    });

    function updateCartAttributes(exposureIds) {
      fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          attributes: {
            '_oce_exposure_ids': JSON.stringify(exposureIds),
            '_oce_session_id': getSessionId()
          }
        })
      }).catch(function(err) {
        console.warn('[OCE] Failed to update cart attributes:', err);
      });
    }

    function getSessionId() {
      var key = '_oce_session_id';
      var sessionId = null;
      try { sessionId = localStorage.getItem(key); } catch(e) {}
      if (!sessionId) {
        sessionId = 'oce_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        try { localStorage.setItem(key, sessionId); } catch(e) {}
      }
      return sessionId;
    }

    document.addEventListener('DOMContentLoaded', function() {
      try {
        var raw = sessionStorage.getItem('_oce_exposure_ids');
        if (raw) {
          var stored = JSON.parse(raw);
          if (stored.length > 0) updateCartAttributes(stored);
        }
      } catch(e) {}
    });
  })();
</script>

{% schema %}
{
  "name": "OCE Tracking SDK",
  "target": "head",
  "settings": []
}
{% endschema %}
